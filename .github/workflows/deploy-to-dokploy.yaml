name: Deploy to Dokploy

permissions:
    contents: read

on:
    push:
        branches:
            - main
        tags:
            - "v*"
            - "b*"
            - "f*"

jobs:
    # --- JOB ДЛЯ БЭКЕНДА ---
    deploy-backend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for backend changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      backend:
                        - 'packages/backend/**'
                        - '.github/workflows/**'

            # 1. DEV: Пуш в main + изменения в backend
            - name: Deploy Backend (Dev)
              if: startsWith(github.ref, 'refs/heads/main') && steps.filter.outputs.backend == 'true'
              run: |
                  curl -v -L -X 'POST' \
                  "${{ secrets.DOKPLOY_DEV_BACKEND_WEBHOOK }}" \
                  -H 'accept: application/json' \
                  -H 'Content-Type: application/json' \
                  -H 'x-api-key: ${{ secrets.DOKPLOY_TOKEN }}' \
                  -d "{\"applicationId\": \"${{ secrets.DOKPLOY_DEV_BACKEND_APP_ID }}\"}" \
                  --fail

            # 2. PROD: Теги v* или b*
            - name: Deploy Backend (Prod)
              if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/b')
              run: |
                  curl -v -L -X 'POST' \
                  "${{ secrets.DOKPLOY_PROD_BACKEND_WEBHOOK }}" \
                  -H 'accept: application/json' \
                  -H 'Content-Type: application/json' \
                  -H 'x-api-key: ${{ secrets.DOKPLOY_TOKEN }}' \
                  -d "{\"applicationId\": \"${{ secrets.DOKPLOY_PROD_BACKEND_APP_ID }}\"}" \
                  --fail

    # --- JOB ДЛЯ ФРОНТЕНДА ---
    deploy-frontend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for frontend changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      frontend:
                        - 'packages/frontend/**'
                        - '.github/workflows/**'

            # 1. DEV: Пуш в main + изменения в frontend
            - name: Deploy Frontend (Dev)
              if: startsWith(github.ref, 'refs/heads/main') && steps.filter.outputs.frontend == 'true'
              run: |
                  curl -v -L -X 'POST' \
                  "${{ secrets.DOKPLOY_DEV_FRONTEND_WEBHOOK }}" \
                  -H 'accept: application/json' \
                  -H 'Content-Type: application/json' \
                  -H 'x-api-key: ${{ secrets.DOKPLOY_TOKEN }}' \
                  -d "{\"applicationId\": \"${{ secrets.DOKPLOY_DEV_FRONTEND_APP_ID }}\"}" \
                  --fail

            # 2. PROD: Теги v* или f*
            - name: Deploy Frontend (Prod)
              if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/f')
              run: |
                  curl -v -L -X 'POST' \
                  "${{ secrets.DOKPLOY_PROD_FRONTEND_WEBHOOK }}" \
                  -H 'accept: application/json' \
                  -H 'Content-Type: application/json' \
                  -H 'x-api-key: ${{ secrets.DOKPLOY_TOKEN }}' \
                  -d "{\"applicationId\": \"${{ secrets.DOKPLOY_PROD_FRONTEND_APP_ID }}\"}" \
                  --fail
