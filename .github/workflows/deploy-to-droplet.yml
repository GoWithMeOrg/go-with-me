name: Deploy to DigitalOcean Droplet

on:
    workflow_run:
        workflows: ['Build and Push Docker Images']
        types:
            - completed
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Droplet
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      set -e

                      # Navigate to deployment directory
                      cd /opt/myapp || { echo "Directory /opt/myapp does not exist. Please create it first."; exit 1; }

                      # Pull latest images from DOCR
                      echo "Pulling latest images from DigitalOcean Container Registry..."
                      docker-compose -f docker-compose.prod.yml pull frontend backend

                      # Start/update services with zero-downtime deployment
                      echo "Updating services..."
                      docker-compose -f docker-compose.prod.yml up -d --no-deps frontend backend

                      # Clean up old images to save space
                      echo "Cleaning up unused Docker images..."
                      docker image prune -f

                      # Show running containers
                      echo "Current running containers:"
                      docker-compose -f docker-compose.prod.yml ps

                      echo "Deployment completed successfully!"

            - name: Verify deployment
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      cd /opt/myapp
                      echo "Checking service health..."
                      docker-compose -f docker-compose.prod.yml ps
                      echo "Checking logs (last 20 lines)..."
                      docker-compose -f docker-compose.prod.yml logs --tail=20
